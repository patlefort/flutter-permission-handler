#!/bin/bash

NS=$1
CMD=$2

case $CMD in
	netns)
		
		case $3 in
			create)
				echo "Creating network namespace $NS."

				# Setup network namespace and lo interface.
				# It is meant to be run inside an anonymous network namespace of a systemd service.
				
				ip link set lo up
				
				flock --no-fork -- /var/run/netns.lock ip netns add $NS
				umount /var/run/netns/$NS
				mount --bind /proc/self/ns/net /var/run/netns/$NS

				;;

			delete)
				echo "Deleting network namespace $NS."

				ip netns delete $NS

				;;
			*)
				echo "Wrong command."
				exit 1
				;;
		esac

		;;

	macvlan)

		case $3 in
			create)
				# Read config
				if [[ ! -f /etc/netns-helper/ns/$NS-macvlan.conf ]]; then
					echo "File /etc/netns-helper/ns/$NS-macvlan.conf not found, exiting."
					exit 1
				fi
				
				source /etc/netns-helper/ns/$NS-macvlan.conf
				
				echo "Creating macvlan interface in $NS with $PARENT_IF."
				echo "MAC address: $MAC"

				# Setup macvlan interface and link it to parent interface.
				ip link add nm_$NS link $PARENT_IF address $MAC type macvlan mode bridge
				if [[ $? != 0 ]]; then
					echo "Failed to create macvlan interface."
					exit $?
				fi

				ip link set nm_$NS netns $NS
				
				# Privacy extensions
				if [ ! -z "$PRIVACY_EXT" ]; then
					sysctl -w net.ipv6.conf.nm_$NS.use_tempaddr=$PRIVACY_EXT
				fi
				
				# Run preup script
				if [[ -x /etc/netns-helper/ns/$NS-macvlan-preup ]]; then
					ip netns exec $NS /etc/netns-helper/ns/$NS-preup nm_$NS
					
					if [[ $? != 0 ]]; then
						exit $?
					fi
				fi
				
				ip netns exec $NS ip link set nm_$NS up
				
				# Configure macvlan interface
				if [ ! -z "$IPADDR4" ]; then
					ip netns exec $NS ip address add $IPADDR4 dev nm_$NS
				fi
				
				if [ ! -z "$DEFAULT_GATEWAY4" ]; then
					ip route add default via $DEFAULT_GATEWAY4 dev nm_$NS onlink
				fi
				
				if [ ! -z "$IPADDR6" ]; then
					ip netns exec $NS ip -6 address add $IPADDR6 dev nm_$NS
				fi
				
				if [ ! -z "$DEFAULT_GATEWAY6" ]; then
					ip -6 route add default via $DEFAULT_GATEWAY6 dev nm_$NS onlink
				fi

				mkdir -p /run/netmachine/$NS
				
				# Run postup script
				if [[ -x /etc/netns-helper/ns/$NS-macvlan-postup ]]; then
					ip netns exec $NS /etc/netns-helper/ns/$NS-postup nm_$NS
					
					if [[ $? != 0 ]]; then
						exit $?
					fi
				fi

				;;
			delete)
				echo "Deleting macvlan interface in namespace $NS."
				ip netns exec $NS ip link delete nm_$NS

				;;
			*)
				echo "Wrong command."
				exit 1
				;;
		esac

		;;
		
	postup)
		
		if [[ -x /etc/netns-helper/ns/$NS-postup ]]; then
			/etc/netns-helper/ns/$NS-postup
			exit $?
		fi
		
		;;
		
	*)
		echo "Wrong command."
		exit 1
		;;
esac
