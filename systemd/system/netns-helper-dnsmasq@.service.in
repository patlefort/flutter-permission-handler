[Unit]
Description=Run dnsmasq in a network namespace.
Documentation=man:dnsmasq(8)
After=netns-helper@%i.service netns-helper-macvlan@%i.service netns-helper-bridged@%i.service
Before=netns-helper-postup@%i.service
BindsTo=netns-helper@%i.service
JoinsNamespaceOf=netns-helper@%i.service
PartOf=netns-helper@%i.target

[Service]
Type=simple
ConfigurationDirectory=netns-helper
PIDFile=%t/netns-helper-%i/dnsmasq.pid
ExecStartPre=dnsmasq --test
ExecStart=dnsmasq -k --interface=lo -z --enable-dbus=uk.org.thekelleys.dnsmasq.%i --cache-size=1000 --user=dnsmasq --pid-file="%t/netns-helper-%i/dnsmasq.pid" --conf-file="/etc/netns-helper/ns/%i-dnsmasq.conf" --conf-file="%t/netns-helper-%i/resolvconf-dnsmasq.conf" --resolv-file="%t/netns-helper-%i/resolvconf-dnsmasq-resolv.conf"
ExecReload=kill -HUP $MAINPID

BindPaths=-/etc/netns/%i/resolv.conf:/etc/resolv.conf
BindPaths=-/etc/netns/%i/nsswitch.conf:/etc/nsswitch.conf

PrivateDevices=true
ProtectSystem=full
PrivateNetwork=true
ProtectHome=true

[Install]
RequiredBy=netns-helper@%i.target
